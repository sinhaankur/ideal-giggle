<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Companion - Emotional AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #000;
            height: 100vh;
            color: #fff;
            overflow: hidden;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr 250px;
            gap: 0;
            height: 100vh;
            background: #000;
        }

        /* ===== LEFT PANEL: PARADIGM VISUALIZATION ===== */
        .paradigm-panel {
            background: #0a0a0a;
            border-right: 2px solid #00ff66;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 12px;
        }

        .paradigm-header {
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 12px;
            color: #00ff66;
            border-bottom: 1px dashed #00ff66;
            padding-bottom: 6px;
        }

        .emotion-pair {
            margin-bottom: 16px;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 2px;
        }

        .emotion-label {
            font-size: 0.75em;
            color: #00ff66;
            margin-bottom: 4px;
        }

        .emotion-bars {
            display: flex;
            gap: 4px;
            align-items: flex-end;
            height: 40px;
            margin-bottom: 4px;
        }

        .emotion-bar {
            flex: 1;
            background: #00ff66;
            border: 1px solid #00ff66;
            cursor: help;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .emotion-bar:hover {
            opacity: 1;
        }

        .human-bar {
            background: #ff6600;
            border-color: #ff6600;
        }

        .emotion-values {
            display: flex;
            justify-content: space-between;
            font-size: 0.7em;
            color: #999;
        }

        .story-nodes-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #00ff66;
        }

        .story-node {
            margin-bottom: 8px;
            padding: 6px 8px;
            background: #1a1a1a;
            border-left: 2px solid #00ff66;
            font-size: 0.7em;
            line-height: 1.3;
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .story-node:hover {
            background: #2a2a2a;
            border-left-color: #00ff00;
            color: #fff;
        }

        .story-time {
            color: #00ff66;
            font-weight: bold;
        }

        .story-emotion {
            color: #ff6600;
            font-size: 0.65em;
        }

        /* ===== CENTER PANEL: CHAT & VISUALIZATION ===== */
        .center-panel {
            display: flex;
            flex-direction: column;
            background: #000;
            border-right: 2px solid #00ff66;
            overflow: hidden;
        }

        .header {
            background: #0a0a0a;
            border-bottom: 2px solid #00ff66;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #00ff66;
            font-size: 1em;
        }

        .header-controls {
            display: flex;
            gap: 6px;
        }

        .header-btn {
            padding: 4px 8px;
            background: #1a1a1a;
            color: #00ff66;
            border: 1px solid #00ff66;
            cursor: pointer;
            font-size: 0.7em;
            font-family: 'Monaco', monospace;
            transition: all 0.2s ease;
        }

        .header-btn:hover {
            background: #00ff66;
            color: #000;
        }

        /* XYZ Visualization Canvas */
        .xyz-canvas-container {
            height: 200px;
            background: #0a0a0a;
            border-bottom: 2px solid #00ff66;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #xyzCanvas {
            border: 1px solid #00ff66;
            background: #000;
            max-width: 100%;
            max-height: 100%;
        }

        /* Chat area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .message {
            display: flex;
            gap: 6px;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 6px 8px;
            border: 1px solid #00ff66;
            font-size: 0.8em;
            line-height: 1.3;
            background: #1a1a1a;
            color: #ccc;
        }

        .message.user .message-bubble {
            background: #1a3a1a;
            border-color: #00ff66;
            color: #fff;
        }

        .message-time {
            font-size: 0.65em;
            color: #666;
        }

        .input-area {
            padding: 8px 12px;
            background: #0a0a0a;
            border-top: 2px solid #00ff66;
            display: flex;
            gap: 6px;
        }

        .message-input {
            flex: 1;
            padding: 6px 8px;
            background: #1a1a1a;
            color: #fff;
            border: 1px solid #00ff66;
            font-family: 'Monaco', monospace;
            font-size: 0.85em;
        }

        .send-btn {
            padding: 6px 12px;
            background: #00ff66;
            color: #000;
            border: 1px solid #00ff66;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8em;
            font-family: 'Monaco', monospace;
            transition: all 0.2s ease;
        }

        .send-btn:hover {
            background: #00ff00;
            border-color: #00ff00;
        }

        /* ===== RIGHT PANEL: CAMERA FEED & STATUS ===== */
        .right-panel {
            background: #0a0a0a;
            border-left: 2px solid #00ff66;
            display: flex;
            flex-direction: column;
            padding: 12px;
            overflow-y: auto;
        }

        .right-header {
            font-size: 0.8em;
            font-weight: bold;
            color: #00ff66;
            margin-bottom: 8px;
            border-bottom: 1px solid #00ff66;
            padding-bottom: 6px;
        }

        .camera-feed-box {
            width: 100%;
            aspect-ratio: 4/3;
            background: #000;
            border: 1px solid #00ff66;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .camera-feed-box video,
        .camera-feed-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-unavailable {
            color: #666;
            font-size: 0.75em;
            text-align: center;
        }

        .status-section {
            margin-bottom: 12px;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #333;
        }

        .status-label {
            font-size: 0.7em;
            color: #00ff66;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 0.75em;
            color: #ccc;
        }

        .ai-model-select {
            width: 100%;
            padding: 4px;
            background: #1a1a1a;
            color: #00ff66;
            border: 1px solid #00ff66;
            font-family: 'Monaco', monospace;
            font-size: 0.75em;
            cursor: pointer;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: #0a0a0a;
            border: 2px solid #00ff66;
            padding: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0, 255, 102, 0.5);
        }

        .modal-title {
            font-size: 1.1em;
            color: #00ff66;
            margin-bottom: 12px;
            border-bottom: 1px solid #00ff66;
            padding-bottom: 6px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            color: #00ff66;
            font-size: 0.8em;
            margin-bottom: 4px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 6px;
            background: #1a1a1a;
            color: #fff;
            border: 1px solid #00ff66;
            font-family: 'Monaco', monospace;
            font-size: 0.8em;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            background: #2a2a2a;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #00ff66;
            background: #1a1a1a;
            color: #00ff66;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Monaco', monospace;
            font-size: 0.8em;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: #00ff66;
            color: #000;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff66;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00ff00;
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- LEFT PANEL: PARADIGM & STORY NODES -->
        <div class="paradigm-panel">
            <div class="paradigm-header">EMOTIONAL PARADIGM</div>
            
            <div id="emotionComparison">
                <div class="emotion-pair">
                    <div class="emotion-label">üòä HAPPY</div>
                    <div class="emotion-bars">
                        <div class="emotion-bar human-bar" id="bar-happy-human" style="height: 0%; background: #ff6600;"></div>
                        <div class="emotion-bar" id="bar-happy-ai" style="height: 0%; background: #00ff66;"></div>
                    </div>
                    <div class="emotion-values">
                        <span>You: <span id="val-happy-human">0%</span></span>
                        <span>AI: <span id="val-happy-ai">0%</span></span>
                    </div>
                </div>

                <div class="emotion-pair">
                    <div class="emotion-label">üò¢ SAD</div>
                    <div class="emotion-bars">
                        <div class="emotion-bar human-bar" id="bar-sad-human" style="height: 0%;"></div>
                        <div class="emotion-bar" id="bar-sad-ai" style="height: 0%;"></div>
                    </div>
                    <div class="emotion-values">
                        <span>You: <span id="val-sad-human">0%</span></span>
                        <span>AI: <span id="val-sad-ai">0%</span></span>
                    </div>
                </div>

                <div class="emotion-pair">
                    <div class="emotion-label">üò† ANGRY</div>
                    <div class="emotion-bars">
                        <div class="emotion-bar human-bar" id="bar-angry-human" style="height: 0%;"></div>
                        <div class="emotion-bar" id="bar-angry-ai" style="height: 0%;"></div>
                    </div>
                    <div class="emotion-values">
                        <span>You: <span id="val-angry-human">0%</span></span>
                        <span>AI: <span id="val-angry-ai">0%</span></span>
                    </div>
                </div>

                <div class="emotion-pair">
                    <div class="emotion-label">üò® FEAR</div>
                    <div class="emotion-bars">
                        <div class="emotion-bar human-bar" id="bar-fear-human" style="height: 0%;"></div>
                        <div class="emotion-bar" id="bar-fear-ai" style="height: 0%;"></div>
                    </div>
                    <div class="emotion-values">
                        <span>You: <span id="val-fear-human">0%</span></span>
                        <span>AI: <span id="val-fear-ai">0%</span></span>
                    </div>
                </div>

                <div class="emotion-pair">
                    <div class="emotion-label">üòê NEUTRAL</div>
                    <div class="emotion-bars">
                        <div class="emotion-bar human-bar" id="bar-neutral-human" style="height: 0%;"></div>
                        <div class="emotion-bar" id="bar-neutral-ai" style="height: 0%;"></div>
                    </div>
                    <div class="emotion-values">
                        <span>You: <span id="val-neutral-human">0%</span></span>
                        <span>AI: <span id="val-neutral-ai">0%</span></span>
                    </div>
                </div>
            </div>

            <div class="story-nodes-section">
                <div class="paradigm-header" style="margin-bottom: 8px;">STORY TIMELINE</div>
                <div id="storyNodesList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- CENTER PANEL: CHAT & XYZ VISUALIZATION -->
        <div class="center-panel">
            <div class="header">
                <div>
                    <h1 id="companionName">Companion</h1>
                    <div style="font-size: 0.7em; color: #999;" id="sessionInfo">Session: Loading...</div>
                </div>
                <div class="header-controls">
                    <button class="header-btn" id="infoBtn">INFO</button>
                    <button class="header-btn" id="editBtn">EDIT</button>
                    <button class="header-btn" id="cameraBtn">CAMERA</button>
                </div>
            </div>

            <div class="xyz-canvas-container">
                <canvas id="xyzCanvas" width="400" height="180"></canvas>
            </div>

            <div class="chat-container">
                <div class="messages-container" id="messagesContainer"></div>
                <div class="input-area">
                    <input 
                        type="text" 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Share your thoughts..."
                    >
                    <button class="send-btn" id="sendBtn">SEND</button>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: CAMERA FEED & STATUS -->
        <div class="right-panel">
            <div class="right-header">CAMERA FEED</div>
            <div class="camera-feed-box">
                <video id="cameraFeedVideo" autoplay muted playsinline style="display: none;"></video>
                <div class="camera-unavailable" id="cameraUnavailable">
                    üìπ Camera unavailable<br>
                    <span style="font-size: 0.7em;">Grant permissions or<br>click CAMERA button</span>
                </div>
            </div>

            <div class="right-header">STATUS</div>
            
            <div class="status-section">
                <div class="status-label">AI MODEL</div>
                <select id="aiModelSelect" class="ai-model-select">
                    <option value="">Loading models...</option>
                </select>
            </div>

            <div class="status-section">
                <div class="status-label">DETECTED EMOTION</div>
                <div class="status-value" id="detectedEmotion">Scanning...</div>
            </div>

            <div class="status-section">
                <div class="status-label">AI STATE</div>
                <div class="status-value" id="aiState">Initializing...</div>
            </div>

            <div class="status-section">
                <div class="status-label">LOCATION</div>
                <div class="status-value" id="locationStatus" style="cursor: pointer;">üìç Requesting...</div>
            </div>

            <div class="status-section">
                <div class="status-label">CONVERSATION</div>
                <div class="status-value" id="conversationStats">Messages: 0 | Tokens: 0</div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <h1 class="modal-title">CREATE COMPANION</h1>
            <form id="createCompanionForm">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="companionName" placeholder="Anita" required>
                </div>

                <div class="form-group">
                    <label>Gender Identity</label>
                    <select id="genderIdentity">
                        <option value="feminine">Feminine</option>
                        <option value="masculine">Masculine</option>
                        <option value="nonbinary">Non-binary</option>
                        <option value="fluid">Fluid</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Archetype</label>
                    <select id="primaryArchetype">
                        <option value="warm">Warm</option>
                        <option value="playful">Playful</option>
                        <option value="intellectual">Intellectual</option>
                        <option value="mysterious">Mysterious</option>
                    </select>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn">CREATE</button>
                    <button type="button" class="btn" id="cancelCreateBtn">CANCEL</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="cameraModalAdvanced">
        <div class="modal-content">
            <h1 class="modal-title">CAMERA MONITOR</h1>
            <div style="text-align: center; margin-bottom: 12px;">
                <video id="cameraModalVideo" autoplay muted playsinline 
                       style="max-width: 100%; border: 1px solid #00ff66; display: none; background: #000;"></video>
                <div id="cameraModalStatus" style="color: #999; font-size: 0.8em;">
                    Click START to begin capture
                </div>
            </div>

            <div class="status-section">
                <div class="status-label">DETECTED EMOTION (CAMERA)</div>
                <div class="status-value" id="cameraDetectedEmotion">--</div>
                <div style="font-size: 0.7em; color: #666; margin-top: 4px;" id="emotionConfidence"></div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn" id="cameraStartBtn">START</button>
                <button type="button" class="btn" id="cameraStopBtn">STOP</button>
                <button type="button" class="btn" id="cameraCloseBtn">CLOSE</button>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL STATE =====
        let companionId = null;
        let currentEmotion = 'neutral';
        let userDetectedEmotion = 'neutral';
        let aiDetectedEmotion = 'neutral';
        let storyNodes = [];
        let conversationHistory = [];
        let messageCount = 0;
        let tokensUsed = 0;

        // Emotion color mapping
        const emotionColors = {
            happy: { hue: 60, icon: 'üòä' },
            sad: { hue: 240, icon: 'üò¢' },
            angry: { hue: 0, icon: 'üò†' },
            fear: { hue: 270, icon: 'üò®' },
            surprised: { hue: 30, icon: 'üòÆ' },
            neutral: { hue: 120, icon: 'üòê' },
            disgust: { hue: 90, icon: 'ü§¢' }
        };

        // ===== INITIALIZATION =====
        async function init() {
            await requestGeolocation();
            await loadAvailableModels();
            await initializeCompanion();
            initXYZVisualization();
            setupEventListeners();
            startCameraPreview();
        }

        async function initializeCompanion() {
            try {
                const response = await fetch('/api/companion/list');
                const companions = await response.json();
                if (companions.length > 0) {
                    companionId = companions[0].id;
                    document.getElementById('companionName').textContent = companions[0].name;
                    document.getElementById('sessionInfo').textContent = `Session: ${companions[0].id.substring(0, 8)}`;
                } else {
                    document.getElementById('createModal').classList.add('open');
                }
            } catch (error) {
                console.error('Failed to load companion:', error);
                document.getElementById('createModal').classList.add('open');
            }
        }

        async function loadAvailableModels() {
            try {
                const response = await fetch('/api/ai/models');
                const models = await response.json();
                const select = document.getElementById('aiModelSelect');
                select.innerHTML = '';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load models:', error);
            }
        }

        // ===== XYZ VISUALIZATION =====
        function initXYZVisualization() {
            const canvas = document.getElementById('xyzCanvas');
            const ctx = canvas.getContext('2d');

            function drawXYZAxes() {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const axisLength = 60;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = '#00ff66';
                ctx.fillStyle = '#00ff66';
                ctx.lineWidth = 2;
                ctx.font = 'bold 10px Monaco';

                // X axis (Red)
                ctx.strokeStyle = '#ff3333';
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(centerX + axisLength, centerY);
                ctx.stroke();
                ctx.fillText('X', centerX + axisLength + 8, centerY - 5);

                // Y axis (Green)
                ctx.strokeStyle = '#00ff66';
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(centerX, centerY - axisLength);
                ctx.stroke();
                ctx.fillText('Y', centerX + 5, centerY - axisLength - 5);

                // Z axis (Blue - diagonal)
                ctx.strokeStyle = '#3366ff';
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(centerX + 45, centerY + 45);
                ctx.stroke();
                ctx.fillText('Z', centerX + 50, centerY + 50);

                // Draw emotion point based on current state
                // emotion intensity (0-100) for each axis
                const x = (conversationHistory.length % 100) / 100;
                const y = (messageCount % 100) / 100;
                const z = (emotionIntensity() / 100);

                // Plot point in 3D space
                const screenX = centerX + (x * axisLength);
                const screenY = centerY - (y * axisLength);
                const screenZ = centerY + (z * 40);

                ctx.fillStyle = emotionColors[currentEmotion].icon ? 'rgba(0, 255, 102, 0.8)' : '#00ff66';
                ctx.beginPath();
                ctx.arc(screenX, screenY, 5, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#00ff66';
                ctx.font = '10px Monaco';
                ctx.fillText(`[${messageCount}, ${conversationHistory.length}, ${Math.round(z*100)}]`, centerX - 50, centerY + 25);
            }

            // Animate
            function animate() {
                drawXYZAxes();
                requestAnimationFrame(animate);
            }
            animate();
        }

        function emotionIntensity() {
            const emotionValues = {
                happy: 0.8,
                sad: 0.6,
                angry: 0.7,
                fear: 0.5,
                surprised: 0.75,
                neutral: 0.5,
                disgust: 0.65
            };
            return (emotionValues[currentEmotion] || 0.5) * 100;
        }

        // ===== STORY NODES SYSTEM =====
        function createStoryNode(userMessage, aiResponse, emotion, timestamp) {
            const node = {
                id: Date.now(),
                timestamp,
                time: new Date(timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                date: new Date(timestamp).toLocaleDateString(),
                userText: userMessage.substring(0, 30) + '...',
                aiText: aiResponse.substring(0, 50) + '...',
                emotion,
                fullUserText: userMessage,
                fullAiText: aiResponse
            };

            storyNodes.unshift(node); // Add to beginning
            if (storyNodes.length > 20) storyNodes.pop(); // Keep last 20

            updateStoryNodesUI();
            return node;
        }

        function updateStoryNodesUI() {
            const container = document.getElementById('storyNodesList');
            container.innerHTML = '';
            
            storyNodes.forEach(node => {
                const nodeEl = document.createElement('div');
                nodeEl.className = 'story-node';
                nodeEl.innerHTML = `
                    <div><span class="story-time">${node.time}</span></div>
                    <div style="font-size: 0.7em; color: #999;">${node.date}</div>
                    <div style="margin: 2px 0; color: #ccc;">"${node.userText}"</div>
                    <div style="margin: 2px 0; color: #999; font-style: italic;">${node.emotion}</div>
                `;
                nodeEl.addEventListener('click', () => {
                    alert(`üìñ STORY NODE\n\nTime: ${node.time} ${node.date}\nEmotion: ${node.emotion}\n\nüë§ You:\n${node.fullUserText}\n\nü§ñ AI:\n${node.fullAiText}`);
                });
                container.appendChild(nodeEl);
            });
        }

        // ===== EMOTION PARADIGM UPDATE =====
        function updateEmotionParadigm(userEmotions, aiEmotions) {
            // Update bars and values
            Object.keys(userEmotions).forEach(emotion => {
                const userVal = userEmotions[emotion] || 0;
                const aiVal = aiEmotions[emotion] || 0;

                // Update human bar
                const humanBar = document.getElementById(`bar-${emotion}-human`);
                const aiBar = document.getElementById(`bar-${emotion}-ai`);
                
                if (humanBar) {
                    humanBar.style.height = userVal + '%';
                    document.getElementById(`val-${emotion}-human`).textContent = userVal + '%';
                }
                
                if (aiBar) {
                    aiBar.style.height = aiVal + '%';
                    document.getElementById(`val-${emotion}-ai`).textContent = aiVal + '%';
                }
            });
        }

        // ===== CHAT FUNCTIONALITY =====
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message || !companionId) return;

            input.value = '';

            // Add user message to UI
            addMessageToUI(message, 'user');
            messageCount++;

            try {
                // Simulated emotion detection (in real scenario, use camera frame analysis)
                const userEmotions = detectUserEmotion(message);
                updateEmotionParadigm(userEmotions, { happy: 30, sad: 20, angry: 10, fear: 15, neutral: 25 });

                // Send to AI
                const selectedModel = document.getElementById('aiModelSelect').value;
                const response = await fetch('/api/companion/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        companion_id: companionId,
                        message,
                        user_emotion: Object.keys(userEmotions).reduce((a, b) => userEmotions[a] > userEmotions[b] ? a : b),
                        ai_model: selectedModel
                    })
                });

                const data = await response.json();
                addMessageToUI(data.response, 'companion');
                currentEmotion = data.emotion_detected || 'neutral';
                document.getElementById('detectedEmotion').textContent = currentEmotion.toUpperCase();
                document.getElementById('aiState').textContent = `Model: ${data.model_used || 'unknown'}`;

                // Create story node
                createStoryNode(message, data.response, currentEmotion, Date.now());

                tokensUsed += Math.ceil(message.length / 4);
                updateConversationStats();

            } catch (error) {
                console.error('Chat error:', error);
                addMessageToUI('Error communicating with AI.', 'error');
            }
        }

        function detectUserEmotion(text) {
            // Simple keyword-based detection
            const emotions = { happy: 0, sad: 0, angry: 0, fear: 0, neutral: 0, surprised: 0, disgust: 0 };
            
            const keywords = {
                happy: ['great', 'awesome', 'love', 'happy', 'excited', 'wonderful', 'fantastic'],
                sad: ['sad', 'depressed', 'lonely', 'miserable', 'bad', 'upset'],
                angry: ['angry', 'furious', 'hate', 'horrible', 'terrible'],
                fear: ['scared', 'afraid', 'worried', 'anxious', 'nervous'],
                surprised: ['wow', 'amazing', 'surprising', 'shocked'],
                disgust: ['gross', 'nasty', 'disgusting', 'yuck']
            };

            const lowerText = text.toLowerCase();
            Object.keys(keywords).forEach(emotion => {
                keywords[emotion].forEach(keyword => {
                    if (lowerText.includes(keyword)) emotions[emotion] += 15;
                });
            });

            // Normalize
            const total = Object.values(emotions).reduce((a, b) => a + b, 0) || 1;
            Object.keys(emotions).forEach(e => emotions[e] = Math.round((emotions[e] / total) * 100));

            if (total === 0) emotions.neutral = 100;

            return emotions;
        }

        function addMessageToUI(text, sender) {
            const container = document.getElementById('messagesContainer');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${sender}`;
            
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            messageEl.innerHTML = `
                <div>
                    <div class="message-bubble">${text}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
            conversationHistory.push({ sender, text, time });
        }

        function updateConversationStats() {
            document.getElementById('conversationStats').textContent = `Messages: ${messageCount} | Tokens: ${tokensUsed}`;
        }

        // ===== CAMERA PREVIEW =====
        async function startCameraPreview() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 320 }, height: { ideal: 240 } } });
                const video = document.getElementById('cameraFeedVideo');
                video.srcObject = stream;
                video.style.display = 'block';
                document.getElementById('cameraUnavailable').style.display = 'none';
            } catch (error) {
                console.warn('Camera access denied:', error);
            }
        }

        // ===== GEOLOCATION =====
        async function requestGeolocation() {
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        document.getElementById('locationStatus').textContent = `üìç ${latitude.toFixed(2)}¬∞, ${longitude.toFixed(2)}¬∞`;
                    },
                    () => {
                        document.getElementById('locationStatus').textContent = 'üìç Denied';
                    }
                );
            }
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            document.getElementById('createCompanionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('companionName').value;
                try {
                    const response = await fetch('/api/companion/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                    const data = await response.json();
                    companionId = data.id;
                    document.getElementById('createModal').classList.remove('open');
                    document.getElementById('companionName').textContent = name;
                } catch (error) {
                    console.error('Failed to create companion:', error);
                }
            });

            document.getElementById('cancelCreateBtn').addEventListener('click', () => {
                document.getElementById('createModal').classList.remove('open');
            });

            document.getElementById('cameraBtn').addEventListener('click', () => {
                document.getElementById('cameraModalAdvanced').classList.add('open');
            });

            document.getElementById('cameraCloseBtn').addEventListener('click', () => {
                document.getElementById('cameraModalAdvanced').classList.remove('open');
            });

            document.getElementById('cameraStartBtn').addEventListener('click', async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    const video = document.getElementById('cameraModalVideo');
                    video.srcObject = stream;
                    video.style.display = 'block';
                    document.getElementById('cameraModalStatus').textContent = 'Camera active - detecting emotions...';
                } catch (error) {
                    document.getElementById('cameraModalStatus').textContent = 'Camera access denied';
                }
            });

            document.getElementById('cameraStopBtn').addEventListener('click', () => {
                const video = document.getElementById('cameraModalVideo');
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.style.display = 'none';
                    document.getElementById('cameraModalStatus').textContent = 'Camera stopped';
                }
            });

            document.getElementById('aiModelSelect').addEventListener('change', async (e) => {
                if (companionId) {
                    try {
                        await fetch(`/api/companion/set-model/${companionId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ai_model: e.target.value })
                        });
                    } catch (error) {
                        console.error('Failed to set model:', error);
                    }
                }
            });
        }

        // Start!
        init();
    </script>
</body>
</html>
