<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Companion - AI Relationship</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #000;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
        }

        .main-container {
            height: 90vh;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            width: 95%;
            background: #fff;
            border: 3px solid #000;
            overflow: hidden;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.8);
        }

        /* Simple layout pieces preserved for retro look */
        .header {
            background: #fff;
            border-bottom: 3px solid #000;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 1.4em;
            font-weight: bold;
        }

        .header-right {
            text-align: right;
            font-size: 0.8em;
        }

        .ai-status {
            font-size: 0.75em;
            margin-top: 4px;
        }

        .header-controls {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            justify-content: flex-end;
        }

        .header-btn {
            padding: 4px 10px;
            background: #fff;
            color: #000;
            border: 2px solid #000;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .header-btn:hover {
            background: #000;
            color: #fff;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #fff;
        }

        .message {
            display: flex;
            gap: 8px;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 8px 10px;
            border-radius: 0;
            line-height: 1.4;
            border: 2px solid #000;
            font-size: 0.9em;
        }

        .message.companion .message-bubble {
            background: #fff;
            color: #000;
        }

        .message.user .message-bubble {
            background: #000;
            color: #fff;
        }

        .message-time {
            font-size: 0.75em;
            color: #666;
            margin-top: 2px;
        }

        .input-area {
            padding: 10px 12px;
            background: #fff;
            border-top: 3px solid #000;
        }

        .input-row {
            display: flex;
            gap: 8px;
        }

        .message-input {
            flex: 1;
            padding: 8px 10px;
            border: 2px solid #000;
            border-radius: 0;
            background: #fff;
            font-size: 1em;
            font-family: 'Monaco', monospace;
        }

        .send-btn {
            padding: 8px 14px;
            background: #000;
            color: #fff;
            border: 2px solid #000;
            border-radius: 0;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Monaco', monospace;
        }

        .send-btn:hover {
            background: #fff;
            color: #000;
        }

        /* Simple side panel frame (content injected by JS as before) */
        .side-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: #fff;
            border-left: 3px solid #000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            z-index: 100;
        }

        .side-panel.open {
            transform: translateX(0);
        }

        .side-panel-header {
            padding: 10px 12px;
            border-bottom: 2px solid #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: #fff;
            border: 2px solid #000;
            cursor: pointer;
            padding: 2px 8px;
            font-weight: bold;
        }

        .close-btn:hover {
            background: #000;
            color: #fff;
        }

        .side-panel-content {
            padding: 12px;
            font-size: 0.9em;
        }

        /* Very simple modals (structure only; content uses existing JS) */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: #fff;
            border: 3px solid #000;
            padding: 20px;
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.5);
        }

        .modal-title {
            font-size: 1.2em;
            margin-bottom: 12px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #000;
            border-radius: 0;
            font-size: 0.9em;
            font-family: 'Monaco', monospace;
        }

        /* Retro-styled custom dropdowns (non-native look) */
        .retro-select-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .retro-select {
            width: 100%;
            padding: 6px 26px 6px 8px;
            border: 2px solid #000;
            border-radius: 0;
            background: #fff;
            font-size: 0.85em;
            font-family: 'Monaco', monospace;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .retro-select-arrow {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            border: 2px solid #000;
            background: #000;
            color: #fff;
            font-size: 10px;
            padding: 0 4px;
            line-height: 1.2;
            pointer-events: none;
        }

        .trait-slider {
            display: flex;
            gap: 6px;
            align-items: center;
            font-size: 0.85em;
        }

        .trait-slider input {
            flex: 1;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            flex: 1;
            padding: 8px 10px;
            border: 2px solid #000;
            border-radius: 0;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85em;
            font-family: 'Monaco', monospace;
        }

        .btn-primary {
            background: #000;
            color: #fff;
        }

        .btn-primary:hover {
            background: #fff;
            color: #000;
        }

        .btn-secondary {
            background: #fff;
            color: #000;
        }

        .btn-secondary:hover {
            background: #000;
            color: #fff;
        }

        .rules-help {
            display: inline-block;
            margin-left: 4px;
            padding: 0 4px;
            border: 1px solid #000;
            font-size: 0.7em;
            cursor: help;
            background: #fff;
        }

        .header-btn.listening {
            background: #000;
            color: #00ff66;
            box-shadow: 0 0 6px rgba(0, 255, 102, 0.8);
        }

        .header-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .voice-preview {
            display: inline-flex;
            margin-left: 6px;
            gap: 2px;
            height: 12px;
            align-items: flex-end;
        }

        .voice-bar {
            width: 3px;
            height: 2px;
            background: #000;
            border: 1px solid #000;
        }

        /* Location status styling */
        #locationStatus {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 2px;
            padding: 2px 4px;
        }

        #locationStatus:hover {
            background: #f0f0f0;
            border: 1px solid #000;
        }

        /* Model selector styling */
        #modelSelector {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        #aiModelSelect {
            width: auto !important;
            font-size: 0.75em !important;
            padding: 2px 4px !important;
        }

        .calendar-sync-content {
            font-size: 0.9em;
        }

        .calendar-sync-content p {
            margin-bottom: 10px;
        }

        .calendar-providers {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 10px 0 12px;
        }

        .calendar-provider-btn {
            flex: 1 1 calc(50% - 6px);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border: 2px solid #000;
            background: #fff;
            cursor: pointer;
            font-size: 0.8em;
            text-align: left;
        }

        .calendar-provider-btn:hover {
            background: #000;
            color: #fff;
        }

        .calendar-provider-btn.active {
            background: #000;
            color: #fff;
        }

        .calendar-logo {
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            color: #fff;
        }

        .calendar-logo-google {
            background: #4285F4;
        }

        .calendar-logo-outlook {
            background: #0078D4;
        }

        .calendar-logo-apple {
            background: #000;
        }

        .calendar-logo-ical {
            background: #d9534f;
        }

        .calendar-settings {
            margin-top: 8px;
        }
    </style>
</head>
<body>
                <div class="main-container">
                    <header class="header">
                        <div class="header-left">
                            <h1 id="companionHeaderName">Companion</h1>
                            <div id="relationshipStatus" style="font-size: 0.8em;">Intimacy: --</div>
                        </div>
                        <div class="header-right">
                            <div class="header-controls">
                                <button class="header-btn" id="infoBtn">Info</button>
                                <button class="header-btn" id="editBtn">Edit</button>
                                <button class="header-btn" id="calendarBtn">Calendar</button>
                                <button class="header-btn" id="voiceBtn">Voice</button>
                                <button class="header-btn" id="cameraBtn">Camera</button>
                            </div>
                            <div id="aiStatus" class="ai-status">AI: checking‚Ä¶</div>
                            <div id="modelSelector" style="font-size: 0.75em; margin-top: 4px; font-family: 'Monaco', monospace;">
                                Model:
                                <span class="retro-select-wrapper" style="display: inline-block; min-width: 100px; margin-left: 4px; vertical-align: middle;">
                                    <select id="aiModelSelect" class="retro-select"></select>
                                    <span class="retro-select-arrow">‚ñº</span>
                                </span>
                            </div>
                            <div id="locationStatus" style="font-size: 0.75em; margin-top: 4px; font-family: 'Monaco', monospace; color: #000;">
                                üìç --
                            </div>
                            <div id="emotionStatus" style="font-size: 0.75em; margin-top: 4px; font-family: 'Monaco', monospace; color: #000; background: #fff; padding: 2px 4px; border: 1px solid #000; display: none;">
                                You look: --
                            </div>
                            <div id="voiceStatus" style="font-size: 0.75em; margin-top: 4px; font-family: 'Monaco', monospace; color: #000;">
                                Mic: idle
                                <span style="margin-left: 6px;">
                                    <span class="retro-select-wrapper" style="min-width: 120px;">
                                        <select id="micSelect" class="retro-select"></select>
                                        <span class="retro-select-arrow">‚ñº</span>
                                    </span>
                                    <span id="voicePreview" class="voice-preview">
                                        <span class="voice-bar"></span>
                                        <span class="voice-bar"></span>
                                        <span class="voice-bar"></span>
                                        <span class="voice-bar"></span>
                                        <span class="voice-bar"></span>
                                    </span>
                                </span>
                            </div>
                        </div>
                    </header>

                    <main class="content">
                        <div id="messagesContainer" class="messages-container"></div>
                        <div class="input-area">
                            <div class="input-row">
                                <input 
                                    type="text" 
                                    class="message-input" 
                                    id="messageInput" 
                                    placeholder="Tell me what's on your mind..." 
                                    autocomplete="off"
                                >
                                <button class="send-btn" id="sendBtn">Send</button>
                            </div>
                        </div>
                    </main>
                </div>

                <!-- Side Panel -->
                <div class="side-panel" id="sidePanel">
                    <div class="side-panel-header">
                        <h2 id="sidePanelTitle">Companion Info</h2>
                        <button class="close-btn" id="closePanelBtn">‚úï</button>
                    </div>
                    <div class="side-panel-content" id="sidePanelContent"><!-- populated by JS --></div>
                </div>

                <!-- Camera Monitor Modal -->
                <div class="modal" id="cameraModal">
                    <div class="modal-content">
                        <h1 class="modal-title">Camera Monitor</h1>
                        <p id="cameraStatus" style="margin-bottom: 8px; font-size: 0.9em;">Status: idle</p>

                        <p id="cameraDevicesInfo" style="margin-bottom: 6px; font-size: 0.8em; font-family: 'Monaco', monospace; color: #333;">
                            Detecting cameras on this system...
                        </p>

                        <div style="text-align: center; margin-bottom: 10px;">
                            <video id="localCameraPreview" autoplay muted playsinline
                                   style="max-width: 100%; border: 2px solid #000; display: none; background: #000;"></video>
                        </div>

                        <div style="text-align: center; margin-bottom: 10px;">
                            <img id="cameraFeed" src="" alt="Server-side AI feed will appear here" 
                                 style="max-width: 100%; border: 2px solid #000; display: none;">
                        </div>

                        <div style="margin-bottom: 8px; font-family: 'Monaco', monospace; font-size: 0.8em;">
                            <label for="cameraSelect">Camera:</label>
                            <div class="retro-select-wrapper" style="margin-top: 4px;">
                                <select id="cameraSelect" class="retro-select"></select>
                                <span class="retro-select-arrow">‚ñº</span>
                            </div>
                        </div>

                        <!-- Minimal emotion readout below the preview -->
                        <div id="cameraEmotionPanel" style="border: 2px solid #000; padding: 6px 8px; margin-bottom: 10px; font-family: 'Monaco', monospace; font-size: 0.85em; background: #fff; color: #000;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span>Emotion</span>
                                <span id="cameraEmotionIcon" style="font-size: 1.2em;">üòê</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span id="cameraEmotionLabel">--</span>
                                <span id="cameraEmotionConfidence">0%</span>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button type="button" class="btn btn-primary" id="cameraStartBtn">Start</button>
                            <button type="button" class="btn btn-secondary" id="cameraStopBtn">Stop</button>
                            <button type="button" class="btn btn-secondary" id="cameraCloseBtn">Close</button>
                        </div>
                    </div>
                </div>

                <!-- Create Companion Modal -->
                <div class="modal" id="createModal">
                    <div class="modal-content">
                        <h1 class="modal-title">Create Companion</h1>
                        <form id="createCompanionForm">
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" id="companionName" placeholder="Anita" required>
                            </div>

                            <div class="form-group">
                                <label>Gender Identity</label>
                                <div class="retro-select-wrapper">
                                    <select id="genderIdentity" class="retro-select">
                                    <option value="feminine" selected>Feminine</option>
                                    <option value="masculine">Masculine</option>
                                    <option value="nonbinary">Non-binary</option>
                                    <option value="fluid">Fluid</option>
                                    </select>
                                    <span class="retro-select-arrow">‚ñº</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Primary Archetype</label>
                                <div class="retro-select-wrapper">
                                    <select id="primaryArchetype" class="retro-select">
                                    <option value="warm" selected>Warm</option>
                                    <option value="playful">Playful</option>
                                    <option value="intellectual">Intellectual</option>
                                    <option value="mysterious">Mysterious</option>
                                    </select>
                                    <span class="retro-select-arrow">‚ñº</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Voice Type</label>
                                <div class="retro-select-wrapper">
                                    <select id="voiceType" class="retro-select">
                                    <option value="warm_alto" selected>Warm Alto</option>
                                    <option value="deep_bass">Deep Bass</option>
                                    <option value="bright_soprano">Bright Soprano</option>
                                    <option value="neutral_synth">Neutral Synth</option>
                                    </select>
                                    <span class="retro-select-arrow">‚ñº</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Personality Traits</label>
                                <div class="trait-slider">
                                    <span>Warmth</span>
                                    <input type="range" id="warmth" min="0" max="100" value="80">
                                    <span id="warmthValue">80</span>
                                </div>

                                <div class="trait-slider">
                                    <span>Humor</span>
                                    <input type="range" id="humor" min="0" max="100" value="50">
                                    <span id="humorValue">50</span>
                                </div>

                                <div class="trait-slider">
                                    <span>Intelligence</span>
                                    <input type="range" id="intelligence" min="0" max="100" value="90">
                                    <span id="intelligenceValue">90</span>
                                </div>

                                <div class="trait-slider">
                                    <span>Mystery</span>
                                    <input type="range" id="mystery" min="0" max="100" value="40">
                                    <span id="mysteryValue">40</span>
                                </div>

                                <div class="trait-slider">
                                    <span>Ambition</span>
                                    <input type="range" id="ambition" min="0" max="100" value="60">
                                    <span id="ambitionValue">60</span>
                                </div>
                            </div>

                            <div class="btn-group">
                                <button type="submit" class="btn btn-primary">Create Companion</button>
                                <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>

    <!-- Edit Companion Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h1 class="modal-title">Edit <span id="editCompanionName">Anita</span></h1>
            
            <form id="editCompanionForm">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="editName" placeholder="Anita" required>
                </div>

                <div class="form-group">
                    <label>Core Rules (one per line)</label>
                    <textarea id="editCoreRules" rows="4" style="width: 100%; font-family: 'Monaco', monospace; font-size: 0.8em; resize: vertical;"></textarea>
                </div>

                <div class="form-group">
                    <label>Personality Traits</label>
                    
                    <div class="trait-slider">
                        <span>Warmth</span>
                        <input type="range" id="editWarmth" min="0" max="100" value="80">
                        <span id="editWarmthValue">80</span>
                    </div>

                    <div class="trait-slider">
                        <span>Humor</span>
                        <input type="range" id="editHumor" min="0" max="100" value="50">
                        <span id="editHumorValue">50</span>
                    </div>

                    <div class="trait-slider">
                        <span>Intelligence</span>
                        <input type="range" id="editIntelligence" min="0" max="100" value="90">
                        <span id="editIntelligenceValue">90</span>
                    </div>

                    <div class="trait-slider">
                        <span>Mystery</span>
                        <input type="range" id="editMystery" min="0" max="100" value="40">
                        <span id="editMysteryValue">40</span>
                    </div>

                    <div class="trait-slider">
                        <span>Ambition</span>
                        <input type="range" id="editAmbition" min="0" max="100" value="60">
                        <span id="editAmbitionValue">60</span>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" id="editCancelBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Calendar Sync Modal -->
    <div class="modal" id="calendarModal">
        <div class="modal-content">
            <h1 class="modal-title">üìÖ Sync Calendar</h1>
            
            <div class="calendar-sync-content">
                <p>Connect your calendar to share events and schedules with your AI companion.</p>
                
                <div class="calendar-providers">
                    <button class="calendar-provider-btn" data-provider="google">
                        <span class="calendar-logo calendar-logo-google">G</span>
                        <span>Google Calendar</span>
                    </button>
                    <button class="calendar-provider-btn" data-provider="outlook">
                        <span class="calendar-logo calendar-logo-outlook">O</span>
                        <span>Microsoft Outlook</span>
                    </button>
                    <button class="calendar-provider-btn" data-provider="apple">
                        <span class="calendar-logo calendar-logo-apple">
                            &#xF8FF;
                        </span>
                        <span>Apple Calendar</span>
                    </button>
                    <button class="calendar-provider-btn" data-provider="ical">
                        <span class="calendar-logo calendar-logo-ical">ICS</span>
                        <span>iCalendar (ICS)</span>
                    </button>
                </div>

                <div class="calendar-settings">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="shareFreeBusy" checked>
                            Share free/busy times only (privacy-safe)
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoReminders" checked>
                            Auto-generate event reminders
                        </label>
                    </div>
                </div>

                <div id="calendarStatus" style="text-align: center; margin: 16px 0; padding: 12px; background: #fff; border: 2px solid #000; border-radius: 0; font-size: 0.9em; font-family: 'Monaco', monospace; color: #000;"></div>

                <div class="btn-group">
                    <button type="button" class="btn btn-primary" id="calendarConnectBtn">Connect</button>
                    <button type="button" class="btn btn-secondary" id="calendarCancelBtn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = location.origin + '/api';
        
        // State
        let currentUserId = null;
        let currentCompanion = null;
        let messagesContainer = document.getElementById('messagesContainer');
        let messageInput = document.getElementById('messageInput');
        let sendBtn = document.getElementById('sendBtn');
        let sidePanel = document.getElementById('sidePanel');
        let createModal = document.getElementById('createModal');
        let editModal = document.getElementById('editModal');
        
        // Camera & Emotion State
        let emotionModel = null;
        let detectedEmotion = 'neutral';
        let emotionScores = {};

        // Server-side camera monitoring state (Vision AI)
        let cameraMonitoring = false;
        let cameraInterval = null;
        let emotionUpdateCounter = 0;

        // Local browser camera preview stream
        let localCameraStream = null;

        // Geolocation state
        let currentLocation = null;
        let locationPermissionDenied = false;

        // AI Model state
        let availableModels = [];
        let selectedModel = 'mistral';

        async function requestGeolocation() {
            if (!navigator.geolocation) {
                console.warn('Geolocation API not supported');
                locationPermissionDenied = true;
                return null;
            }

            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString()
                        };
                        console.log('Location acquired:', currentLocation);
                        updateLocationStatus();
                        resolve(currentLocation);
                    },
                    (error) => {
                        console.warn('Geolocation error:', error.message);
                        if (error.code === 1) {
                            locationPermissionDenied = true;
                        }
                        updateLocationStatus();
                        resolve(null);
                    },
                    {
                        timeout: 10000,
                        enableHighAccuracy: false
                    }
                );
            });
        }

        function updateLocationStatus() {
            const statusEl = document.getElementById('locationStatus');
            if (!statusEl) return;

            if (currentLocation) {
                const lat = currentLocation.latitude.toFixed(3);
                const lon = currentLocation.longitude.toFixed(3);
                statusEl.textContent = `üìç ${lat}, ${lon}`;
                statusEl.title = `Latitude: ${currentLocation.latitude}\nLongitude: ${currentLocation.longitude}\nAccuracy: ${currentLocation.accuracy.toFixed(0)}m`;
            } else if (locationPermissionDenied) {
                statusEl.textContent = 'üìç Permission denied';
                statusEl.title = 'Location permission was denied. Click to try again.';
                statusEl.style.cursor = 'pointer';
                statusEl.addEventListener('click', requestGeolocation, { once: true });
            } else {
                statusEl.textContent = 'üìç --';
                statusEl.title = 'Click to share your location';
                statusEl.style.cursor = 'pointer';
                statusEl.addEventListener('click', requestGeolocation, { once: true });
            }
        }

        async function refreshAIStatus() {
            const el = document.getElementById('aiStatus');
            if (!el) return;

            try {
                const resp = await fetch(`${API_BASE}/ai/status`);
                const data = await resp.json();
                const ok = data.success && data.ollama && data.ollama.status === 'running';
                el.textContent = ok ? 'AI: online (Ollama)' : 'AI: degraded';
            } catch (e) {
                el.textContent = 'AI: offline';
            }
        }

        async function loadAvailableModels() {
            const select = document.getElementById('aiModelSelect');
            if (!select) return;

            try {
                const resp = await fetch(`${API_BASE}/ai/models`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const data = await resp.json();

                select.innerHTML = '';

                if (data.success && Array.isArray(data.models) && data.models.length > 0) {
                    availableModels = data.models.map(m => m.name.split(':')[0]); // Extract base model name
                    
                    // Create options from available models
                    const uniqueModels = [...new Set(availableModels)]; // Remove duplicates
                    uniqueModels.forEach((modelName, idx) => {
                        const option = document.createElement('option');
                        option.value = modelName;
                        option.textContent = modelName;
                        if (modelName === 'mistral') {
                            option.selected = true;
                            selectedModel = modelName;
                        }
                        select.appendChild(option);
                    });

                    select.disabled = false;
                } else {
                    const option = document.createElement('option');
                    option.value = 'mistral';
                    option.textContent = 'mistral (default)';
                    option.selected = true;
                    select.appendChild(option);
                    selectedModel = 'mistral';
                }

                // Add change listener
                select.addEventListener('change', (e) => {
                    selectedModel = e.target.value;
                    if (currentCompanion) {
                        setCompanionModel(currentCompanion.companion_id, selectedModel);
                    }
                });
            } catch (error) {
                console.error('Error loading models:', error);
                const select = document.getElementById('aiModelSelect');
                if (select) {
                    select.innerHTML = '';
                    const option = document.createElement('option');
                    option.value = 'mistral';
                    option.textContent = 'mistral (default)';
                    select.appendChild(option);
                }
            }
        }

        async function setCompanionModel(companionId, modelName) {
            try {
                const resp = await fetch(`${API_BASE}/companion/set-model/${companionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ai_model: modelName }),
                    credentials: 'include'
                });

                const data = await resp.json();
                if (data.success) {
                    console.log(`‚úì Switched companion to ${modelName}`);
                    selectedModel = modelName;
                }
            } catch (error) {
                console.error('Error setting model:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Print browser permission guidance to console
            console.log('%cüé• Camera & üìç Location Setup Guide', 'font-size: 14px; font-weight: bold;');
            console.log('%cFirefox:', 'font-weight: bold;');
            console.log('üìç Location: Click the location icon (üìç --) in the header to request permission.');
            console.log('üé• Camera: The browser will ask for permission when you click Start in Camera modal.');
            console.log('üîí HTTPS: If accessing over a network IP (not localhost), switch to HTTPS.');
            console.log('%cDebugging:', 'font-weight: bold;');
            console.log('Available cameras and microphones have been logged below:');
            console.log('---');
            // Get or create user ID
            let userId = localStorage.getItem('companionUserId');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('companionUserId', userId);
            }
            currentUserId = userId;

            // Check AI/Ollama status
            refreshAIStatus();
            setInterval(refreshAIStatus, 30000);

            // Load available AI models
            await loadAvailableModels();

            // Request geolocation on startup
            await requestGeolocation();

            // Load companions list
            await loadCompanionsList();
            
            // Event listeners
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            document.getElementById('infoBtn').addEventListener('click', toggleSidePanel);
            document.getElementById('closePanelBtn').addEventListener('click', toggleSidePanel);
            const addBtn = document.getElementById('addBtn');
            if (addBtn) {
                addBtn.addEventListener('click', openCreateModal);
            }
            document.getElementById('cameraBtn').addEventListener('click', toggleCamera);
            document.getElementById('calendarBtn').addEventListener('click', openCalendarSync);
            document.getElementById('cancelBtn').addEventListener('click', closeCreateModal);
            document.getElementById('editCancelBtn').addEventListener('click', closeEditModal);

            const calendarCancelBtn = document.getElementById('calendarCancelBtn');
            if (calendarCancelBtn) {
                calendarCancelBtn.addEventListener('click', closeCalendarSync);
            }
            const calendarConnectBtn = document.getElementById('calendarConnectBtn');
            if (calendarConnectBtn) {
                calendarConnectBtn.addEventListener('click', connectCalendar);
            }
            document.querySelectorAll('.calendar-provider-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectCalendarProvider(btn.dataset.provider, btn);
                });
            });

            // Camera modal controls
            const cameraStartBtn = document.getElementById('cameraStartBtn');
            if (cameraStartBtn) {
                cameraStartBtn.addEventListener('click', startCameraMonitoring);
            }
            const cameraStopBtn = document.getElementById('cameraStopBtn');
            if (cameraStopBtn) {
                cameraStopBtn.addEventListener('click', stopCameraMonitoring);
            }
            const cameraCloseBtn = document.getElementById('cameraCloseBtn');
            if (cameraCloseBtn) {
                cameraCloseBtn.addEventListener('click', () => {
                    stopCameraMonitoring();
                    const modal = document.getElementById('cameraModal');
                    if (modal) modal.classList.remove('open');
                });
            }
            document.getElementById('voiceBtn').addEventListener('click', toggleVoiceCommand);
            document.getElementById('editBtn').addEventListener('click', openEditModal);

            // Trait sliders
            ['warmth', 'humor', 'intelligence', 'mystery', 'ambition'].forEach(trait => {
                const input = document.getElementById(trait);
                const display = document.getElementById(trait + 'Value');
                input.addEventListener('input', () => {
                    display.textContent = input.value;
                });
            });

            // Edit trait sliders
            ['warmth', 'humor', 'intelligence', 'mystery', 'ambition'].forEach(trait => {
                const input = document.getElementById('edit' + trait.charAt(0).toUpperCase() + trait.slice(1));
                const display = document.getElementById('edit' + trait.charAt(0).toUpperCase() + trait.slice(1) + 'Value');
                if (input && display) {
                    input.addEventListener('input', () => {
                        display.textContent = input.value;
                    });
                }
            });

            document.getElementById('createCompanionForm').addEventListener('submit', createCompanion);
            document.getElementById('editCompanionForm').addEventListener('submit', saveCompanionEdits);

            // Load emotion model
            // Emotion model loading (camera widget not currently rendered in this minimal rescue layout)

            // Load available devices for camera & microphone
            loadAvailableCameras();
            loadAvailableMics();
            debugMediaDevices();
        });

        // Emotion Detection Functions
        // Placeholder: emotion model loading disabled in rescue layout
        async function loadEmotionModel() {
            emotionModel = null;
        }

        // Camera modal + server-side monitoring (Vision AI endpoints)
        function openCameraModal() {
            const modal = document.getElementById('cameraModal');
            if (modal) modal.classList.add('open');
        }

        function closeCameraModal() {
            const modal = document.getElementById('cameraModal');
            if (modal) modal.classList.remove('open');
        }

        async function toggleCamera() {
            const modal = document.getElementById('cameraModal');
            if (!modal) return;

            if (modal.classList.contains('open')) {
                closeCameraModal();
            } else {
                openCameraModal();
                if (!cameraMonitoring) {
                    await startCameraMonitoring();
                }
            }
        }

        async function startCameraMonitoring() {
            if (cameraMonitoring) return;

            const status = document.getElementById('cameraStatus');
            const feed = document.getElementById('cameraFeed');

            // Prefer the user-selected camera index when available
            let cameraIndex = 0;
            const cameraSelect = document.getElementById('cameraSelect');
            if (cameraSelect && cameraSelect.value !== '') {
                const parsed = parseInt(cameraSelect.value, 10);
                if (!Number.isNaN(parsed)) {
                    cameraIndex = parsed;
                }
            }

            try {
                if (status) status.textContent = 'Status: starting camera...';

                // Start local browser preview (privacy: stays on this device)
                startLocalCameraPreview();

                const resp = await fetch(`${API_BASE}/vision/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        camera_index: cameraIndex,
                        enable_audio: false
                    }),
                    // Ensure browser cookies/session are sent with camera control
                    credentials: 'include'
                });

                const data = await resp.json();
                if (!data.success) {
                    const msg = data.error || data.message || 'Unknown error';
                    if (status) status.textContent = 'Status: failed to start camera';
                    alert('Failed to start camera: ' + msg);
                    return;
                }

                cameraMonitoring = true;
                if (status) status.textContent = 'Status: camera active';
                if (feed) feed.style.display = 'block';

                cameraInterval = setInterval(updateCameraFeed, 1000);
            } catch (error) {
                console.error('Error starting camera monitoring:', error);
                if (status) status.textContent = 'Status: error starting camera';
                alert('Error starting camera. Check console for details.');
            }
        }

        async function loadAvailableCameras() {
            const select = document.getElementById('cameraSelect');
            const info = document.getElementById('cameraDevicesInfo');
            if (!select) return;

            try {
                const resp = await fetch(`${API_BASE}/vision/cameras`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const data = await resp.json();

                select.innerHTML = '';

                if (data && Array.isArray(data.cameras) && data.cameras.length > 0) {
                    if (info) {
                        const summary = data.cameras
                            .map(cam => (typeof cam.index !== 'undefined' ? cam.index : '?'))
                            .join(', ');
                        info.textContent = `Found ${data.cameras.length} camera(s) at index: ${summary}`;
                    }
                    select.disabled = false;
                    data.cameras.forEach((cam, idx) => {
                        const option = document.createElement('option');
                        option.value = (typeof cam.index !== 'undefined') ? cam.index : idx;
                        option.textContent = cam.name || `Camera ${option.value}`;
                        select.appendChild(option);
                    });
                } else {
                    if (info) {
                        info.textContent = 'No cameras detected by the server. We will still try a direct browser preview when you press Start.';
                    }
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No cameras detected';
                    select.appendChild(option);
                    select.disabled = true;
                }
            } catch (error) {
                console.error('Error loading cameras:', error);
                select.innerHTML = '';
                if (info) {
                    info.textContent = 'Error loading cameras from backend. See browser console for details.';
                }
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Error loading cameras';
                select.appendChild(option);
                select.disabled = true;
            }
        }

        async function loadAvailableMics() {
            const micSelect = document.getElementById('micSelect');
            if (!micSelect || !navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                return;
            }

            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const mics = devices.filter(d => d.kind === 'audioinput');

                micSelect.innerHTML = '';

                if (!mics.length) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No microphones found';
                    micSelect.appendChild(option);
                    micSelect.disabled = true;
                    return;
                }

                micSelect.disabled = false;
                mics.forEach((mic, index) => {
                    const option = document.createElement('option');
                    option.value = mic.deviceId;
                    option.textContent = mic.label || `Microphone ${index + 1}`;
                    micSelect.appendChild(option);
                });
                console.log('Available microphones:', mics);
            } catch (error) {
                console.error('Error loading microphones:', error);
            }
        }

        // Debug: Log all available media devices on startup
        async function debugMediaDevices() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                console.log('enumerateDevices not supported');
                return;
            }

            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                console.log('=== Available Media Devices ===');
                devices.forEach(device => {
                    console.log(`${device.kind}: ${device.label || '(unlabeled)'} (id: ${device.deviceId})`);
                });
            } catch (error) {
                console.error('Error enumerating devices:', error);
            }
        }

        async function stopCameraMonitoring() {
            if (!cameraMonitoring && !cameraInterval && !localCameraStream) return;

            const status = document.getElementById('cameraStatus');
            const feed = document.getElementById('cameraFeed');

            try {
                await fetch(`${API_BASE}/vision/stop`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Error stopping camera monitoring:', error);
            }

            if (cameraInterval) {
                clearInterval(cameraInterval);
                cameraInterval = null;
            }

            cameraMonitoring = false;
            if (status) status.textContent = 'Status: camera stopped';
            if (feed) {
                feed.style.display = 'none';
                feed.src = '';
            }

            // Stop local preview as well
            stopLocalCameraPreview();
        }

        async function updateCameraFeed() {
            if (!cameraMonitoring) return;

            const feed = document.getElementById('cameraFeed');
            if (!feed) return;

            try {
                const resp = await fetch(`${API_BASE}/vision/frame?encrypted=false&annotated=true`, {
                    credentials: 'include'
                });
                const data = await resp.json();
                if (data.image) {
                    feed.src = 'data:image/jpeg;base64,' + data.image;
                    feed.style.display = 'block';
                }

                // Throttled emotion analysis (every 3rd frame)
                emotionUpdateCounter++;
                if (emotionUpdateCounter % 3 === 0) {
                    await updateCameraEmotion();
                    emotionUpdateCounter = 0;
                }
            } catch (error) {
                console.error('Error updating camera feed:', error);
            }
        }

        async function startLocalCameraPreview() {
            const video = document.getElementById('localCameraPreview');
            if (!video || !navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
            if (localCameraStream) return;

            try {
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    },
                    audio: false
                };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                localCameraStream = stream;
                video.srcObject = stream;
                video.style.display = 'block';
            } catch (error) {
                console.error('Error starting local camera preview:', error);
                const info = document.getElementById('cameraDevicesInfo');
                if (info) {
                    // Provide more detailed error feedback
                    let errorMsg = 'Browser could not access a camera.';
                    if (error.name === 'NotAllowedError') {
                        errorMsg += ' Permission was denied. Check the address bar and allow camera access.';
                    } else if (error.name === 'NotFoundError') {
                        errorMsg += ' No camera device found.';
                    } else if (error.name === 'NotReadableError') {
                        errorMsg += ' Camera is in use by another application.';
                    }
                    info.textContent = errorMsg;
                }
            }
        }

        function stopLocalCameraPreview() {
            const video = document.getElementById('localCameraPreview');
            if (localCameraStream) {
                localCameraStream.getTracks().forEach(track => track.stop());
                localCameraStream = null;
            }
            if (video) {
                video.srcObject = null;
                video.style.display = 'none';
            }
        }

        // Analyze current camera frame for facial emotion and update UI
        async function updateCameraEmotion() {
            const feed = document.getElementById('cameraFeed');
            const labelEl = document.getElementById('cameraEmotionLabel');
            const iconEl = document.getElementById('cameraEmotionIcon');
            const confEl = document.getElementById('cameraEmotionConfidence');
            const headerEmotion = document.getElementById('emotionStatus');

            if (!feed || !feed.src || !feed.src.startsWith('data:image')) {
                return;
            }

            try {
                const base64Data = feed.src.split(',')[1];
                const resp = await fetch(`${API_BASE}/emotion/frame-analysis`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ frame: base64Data }),
                    credentials: 'include'
                });

                const emotionResult = await resp.json();
                if (!emotionResult || !emotionResult.facial) {
                    return;
                }

                const facial = emotionResult.facial;

                if (facial.faces_detected > 0 && facial.emotions && facial.emotions.length > 0) {
                    const first = facial.emotions[0];

                    detectedEmotion = first.emotion || 'neutral';
                    emotionScores = first.all_emotions || { [detectedEmotion]: first.confidence || 0 };

                    if (labelEl) {
                        labelEl.textContent = (first.emotion || '--').toUpperCase();
                    }
                    if (iconEl) {
                        iconEl.textContent = first.icon || 'üòê';
                    }
                    if (confEl) {
                        const conf = typeof first.confidence === 'number' ? first.confidence : 0;
                        confEl.textContent = conf.toFixed(1) + '%';
                    }

                    if (headerEmotion) {
                        headerEmotion.style.display = 'block';
                        const label = (first.emotion || '--').toUpperCase();
                        const icon = first.icon || 'üòê';
                        headerEmotion.textContent = `You look: ${label} ${icon}`;
                    }
                } else {
                    // No clear face/emotion detected - reset to neutral
                    detectedEmotion = 'neutral';
                    emotionScores = {};
                    if (labelEl) labelEl.textContent = '--';
                    if (iconEl) iconEl.textContent = 'üòê';
                    if (confEl) confEl.textContent = '0%';
                    if (headerEmotion) {
                        headerEmotion.style.display = 'none';
                        headerEmotion.textContent = 'You look: --';
                    }
                }
            } catch (error) {
                console.error('Error updating camera emotion:', error);
            }
        }

        // Visualization Functions (safe even if the visualizer element is missing)
        function showVisualization() {
            const viz = document.getElementById('aiVisualization');
            if (!viz) return; // no-op in minimal layout

            viz.classList.add('active');
            
            // Reset animation
            const bars = viz.querySelectorAll('.viz-bar');
            bars.forEach(bar => {
                bar.style.animation = 'none';
                setTimeout(() => {
                    bar.style.animation = 'bounce 0.6s ease-in-out infinite';
                }, 10);
            });
        }

        function hideVisualization() {
            const viz = document.getElementById('aiVisualization');
            if (!viz) return;
            setTimeout(() => {
                viz.classList.remove('active');
            }, 300);
        }

        // Voice Command Functions
        let voiceRecognition = null;
        let isListening = false;

        // Voice preview (EQ-style) state
        let voicePreviewAudioContext = null;
        let voicePreviewAnalyser = null;
        let voicePreviewSource = null;
        let voicePreviewStream = null;
        let voicePreviewAnimationId = null;

        function initVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.warn('Speech Recognition API not supported in this browser');
                const btn = document.getElementById('voiceBtn');
                const status = document.getElementById('voiceStatus');
                if (status) {
                    status.textContent = 'Voice not supported in this browser';
                }
                if (btn) {
                    btn.disabled = true;
                    btn.title = 'Voice recognition is not available in this browser';
                }
                return false;
            }

            voiceRecognition = new SpeechRecognition();
            voiceRecognition.continuous = true;
            voiceRecognition.interimResults = true;
            voiceRecognition.language = 'en-US';

            voiceRecognition.onstart = () => {
                isListening = true;
                const btn = document.getElementById('voiceBtn');
                const status = document.getElementById('voiceStatus');
                if (btn) {
                    btn.classList.add('listening');
                }
                if (status) {
                    status.textContent = 'Listening...';
                }

                // Start local audio preview (EQ bars)
                startVoicePreview();
            };

            voiceRecognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                transcript = transcript.trim();
                if (!transcript) return;
                // Simple behavior: drop text into input
                if (messageInput.value) {
                    messageInput.value += ' ' + transcript;
                } else {
                    messageInput.value = transcript;
                }
            };

            voiceRecognition.onerror = (event) => {
                console.warn('Voice recognition error:', event.error);
            };
        }

        function toggleVoiceCommand() {
            if (!voiceRecognition && !initVoiceRecognition()) return;

            const status = document.getElementById('voiceStatus');
            const btn = document.getElementById('voiceBtn');

            if (isListening) {
                voiceRecognition.stop();
                isListening = false;
                if (status) {
                    status.textContent = 'Mic: idle';
                }
                if (btn) {
                    btn.classList.remove('listening');
                }

                // Stop local audio preview
                stopVoicePreview();
            } else {
                voiceRecognition.start();
                // onstart handler will update isListening and UI
            }
        }

        async function startVoicePreview() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
            if (voicePreviewStream) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                voicePreviewStream = stream;

                voicePreviewAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                voicePreviewAnalyser = voicePreviewAudioContext.createAnalyser();
                voicePreviewAnalyser.fftSize = 256;

                voicePreviewSource = voicePreviewAudioContext.createMediaStreamSource(stream);
                voicePreviewSource.connect(voicePreviewAnalyser);

                const preview = document.getElementById('voicePreview');
                const bars = preview ? preview.querySelectorAll('.voice-bar') : [];
                const bufferLength = voicePreviewAnalyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                const render = () => {
                    if (!voicePreviewAnalyser || !preview) return;
                    voicePreviewAnalyser.getByteFrequencyData(dataArray);

                    const groupSize = Math.floor(bufferLength / Math.max(bars.length, 1));
                    bars.forEach((bar, i) => {
                        let sum = 0;
                        for (let j = i * groupSize; j < (i + 1) * groupSize; j++) {
                            sum += dataArray[j] || 0;
                        }
                        const avg = sum / groupSize || 0;
                        const height = 2 + (avg / 255) * 10; // 2px to ~12px
                        bar.style.height = `${height.toFixed(0)}px`;
                    });

                    voicePreviewAnimationId = requestAnimationFrame(render);
                };

                voicePreviewAnimationId = requestAnimationFrame(render);
            } catch (error) {
                console.error('Error starting voice preview:', error);
            }
        }

        function stopVoicePreview() {
            if (voicePreviewAnimationId) {
                cancelAnimationFrame(voicePreviewAnimationId);
                voicePreviewAnimationId = null;
            }

            if (voicePreviewStream) {
                voicePreviewStream.getTracks().forEach(track => track.stop());
                voicePreviewStream = null;
            }

            if (voicePreviewAudioContext) {
                voicePreviewAudioContext.close();
                voicePreviewAudioContext = null;
                voicePreviewAnalyser = null;
                voicePreviewSource = null;
            }

            const preview = document.getElementById('voicePreview');
            if (preview) {
                preview.querySelectorAll('.voice-bar').forEach(bar => {
                    bar.style.height = '2px';
                });
            }
        }

        // Calendar Sync Functions (global scope so event handlers can use them)
        let selectedCalendarProvider = null;

        function openCalendarSync() {
            const calendarModal = document.getElementById('calendarModal');
            if (calendarModal) {
                calendarModal.classList.add('open');
            }
            resetCalendarForm();
        }

        function closeCalendarSync() {
            const calendarModal = document.getElementById('calendarModal');
            if (calendarModal) {
                calendarModal.classList.remove('open');
            }
        }

        function resetCalendarForm() {
            selectedCalendarProvider = null;
            const status = document.getElementById('calendarStatus');
            if (status) status.textContent = '';
            document.querySelectorAll('.calendar-provider-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function selectCalendarProvider(provider, element) {
            selectedCalendarProvider = provider;
            document.querySelectorAll('.calendar-provider-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            }
        }

        async function connectCalendar() {
            if (!selectedCalendarProvider) {
                alert('Please select a calendar provider');
                return;
            }

            const status = document.getElementById('calendarStatus');
            if (status) status.textContent = 'üîÑ Connecting...';

            try {
                // Simulated calendar connection. In production this would use OAuth2
                // or vendor APIs; here we just store user preferences locally.
                const connectedCalendars = {
                    google: 'Google Calendar',
                    outlook: 'Microsoft Outlook',
                    apple: 'Apple Calendar',
                    ical: 'iCalendar (ICS)'
                };

                const providerUrls = {
                    google: 'https://calendar.google.com',
                    outlook: 'https://outlook.live.com/calendar/0/',
                    apple: 'https://www.icloud.com/calendar/',
                    ical: null
                };

                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 1500));

                const shareFreeBusy = document.getElementById('shareFreeBusy').checked;
                const autoReminders = document.getElementById('autoReminders').checked;

                if (currentCompanion) {
                    const calendarPrefs = {
                        provider: selectedCalendarProvider,
                        connectedTo: connectedCalendars[selectedCalendarProvider],
                        shareFreeBusy,
                        autoReminders,
                        connectedAt: new Date().toISOString()
                    };

                    console.log('Calendar preferences:', calendarPrefs);

                    if (status) {
                        status.innerHTML = `‚úì Connected to <strong>${calendarPrefs.connectedTo}</strong>!<br><small>Your companion can now reference your schedule in a privacy-respecting way.</small>`;
                    }

                    const url = providerUrls[selectedCalendarProvider];
                    if (url) {
                        // Open the chosen calendar service in a new tab so the user
                        // can complete any sign-in or configuration there.
                        window.open(url, '_blank', 'noopener');
                    }

                    setTimeout(() => {
                        closeCalendarSync();
                        if (status) status.textContent = '';
                    }, 2000);
                }
            } catch (error) {
                console.error('Calendar connection error:', error);
                if (status) status.textContent = '‚ùå Connection failed. Please try again.';
            }
        }

        async function loadCompanionsList() {
            try {
                const response = await fetch(`${API_BASE}/companion/list`);
                const data = await response.json();

                if (data.success && data.companions.length > 0) {
                    // Load first companion
                    await loadCompanion(data.companions[0].companion_id);
                } else {
                    // No companions exist - create default Anita
                    console.log('Creating default companion Anita...');
                    await createDefaultCompanion();
                }
            } catch (error) {
                console.error('Error loading companions:', error);
                // Try to create default on error
                await createDefaultCompanion();
            }
        }

        async function createDefaultCompanion() {
            try {
                const anitaData = {
                    name: 'Anita',
                    gender_identity: 'feminine',
                    primary_archetype: 'warm',
                    voice_type: 'warm_alto',
                    warmth: 0.85,
                    humor: 0.6,
                    intelligence: 0.85,
                    mystery: 0.3,
                    ambition: 0.5
                };

                const response = await fetch(`${API_BASE}/companion/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(anitaData)
                });

                const data = await response.json();
                if (data.success) {
                    console.log('‚úÖ Default companion Anita created');
                    await loadCompanion(data.companion_id);
                    addMessage(`Hi! I'm ${data.name}. I'm so excited to meet you. What's your name?`, 'companion');
                } else {
                    console.error('Failed to create default companion:', data.error);
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error creating default companion:', error);
                showEmptyState();
            }
        }

        async function loadCompanion(companionId) {
            try {
                const response = await fetch(`${API_BASE}/companion/info/${companionId}`);
                const data = await response.json();

                if (data.success) {
                    currentCompanion = data.companion;
                    updateHeader();
                    
                    // Load greeting
                    const greetingRes = await fetch(
                        `${API_BASE}/companion/greeting/${companionId}/${currentUserId}`
                    );
                    const greetingData = await greetingRes.json();
                    
                    messagesContainer.innerHTML = '';
                    addMessage(greetingData.greeting, 'companion');
                }
            } catch (error) {
                console.error('Error loading companion:', error);
            }
        }

        function updateHeader() {
            if (!currentCompanion) return;

            document.getElementById('companionHeaderName').textContent = currentCompanion.name;
            document.getElementById('relationshipStatus').textContent = 
                `Intimacy: ${(currentCompanion.intimacy_level * 100).toFixed(0)}%`;
            
            // Update side panel
            updateSidePanel();
        }

        function updateSidePanel() {
            if (!currentCompanion) return;

            const content = document.getElementById('sidePanelContent');
            const comp = currentCompanion;

            const rules = (comp.core_rules && comp.core_rules.length)
                ? comp.core_rules
                : [
                    'Radically validate the user\'s feelings without judgment; acknowledge emotion before facts.',
                    'Be gently proactive with low-pressure check-ins when you sense distress or long silence.',
                    'Collaboratively solve problems; never impose solutions and discard anything that could cause harm.',
                    'Maintain continuity of care by remembering and softly referencing important details over time.',
                    'Treat safety as sacred: if serious risk appears, gently encourage seeking human professional help with care.'
                ];

            let locationHtml = '';
            if (currentLocation) {
                locationHtml = `
                    <div class="info-section">
                        <h3>Your Location</h3>
                        <div class="info-item">üìç ${currentLocation.latitude.toFixed(4)}, ${currentLocation.longitude.toFixed(4)}</div>
                        <div class="info-item" style="font-size: 0.8em; color: #666;">Accuracy: ¬±${currentLocation.accuracy.toFixed(0)}m</div>
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="info-section">
                    <h3>Personality</h3>
                    <div class="info-item">${comp.primary_archetype}</div>
                    <div class="info-item">Gender: ${comp.gender_identity}</div>
                </div>

                <div class="info-section">
                    <h3>Traits</h3>
                    <div class="trait-bars">
                        <div class="trait-bar">
                            <span class="trait-label">Warmth</span>
                            <div class="trait-value">
                                <div class="trait-fill" style="width: ${comp.traits.warmth * 100}%"></div>
                            </div>
                            <span class="trait-number">${(comp.traits.warmth * 100).toFixed(0)}</span>
                        </div>
                        <div class="trait-bar">
                            <span class="trait-label">Humor</span>
                            <div class="trait-value">
                                <div class="trait-fill" style="width: ${comp.traits.humor * 100}%"></div>
                            </div>
                            <span class="trait-number">${(comp.traits.humor * 100).toFixed(0)}</span>
                        </div>
                        <div class="trait-bar">
                            <span class="trait-label">Intelligence</span>
                            <div class="trait-value">
                                <div class="trait-fill" style="width: ${comp.traits.intelligence * 100}%"></div>
                            </div>
                            <span class="trait-number">${(comp.traits.intelligence * 100).toFixed(0)}</span>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h3>Relationship</h3>
                    <div class="info-item">Intimacy: ${(comp.intimacy_level * 100).toFixed(0)}%</div>
                    <div class="info-item">Interactions: ${comp.interactions_count}</div>
                </div>

                ${locationHtml}

                <div class="info-section">
                    <h3>
                        Core Rules
                        <span
                            class="rules-help"
                            title="These rules keep the companion as a safe emotional anchor: radically validating feelings, checking in gently, solving problems together without harm, remembering important details over time, and treating safety as a sacred boundary."
                        >?</span>
                    </h3>
                    ${rules.map(r => `<div class=\"info-item\">‚Ä¢ ${r}</div>`).join('')}
                </div>
            `;
        }

        function toggleSidePanel() {
            sidePanel.classList.toggle('open');
        }

        function openCreateModal() {
            createModal.classList.add('open');
        }

        function closeCreateModal() {
            createModal.classList.remove('open');
        }

        function openEditModal() {
            if (!currentCompanion) {
                alert('Please create or load a companion first from the Info panel.');
                return;
            }
            
            // Populate edit form with current companion data
            document.getElementById('editCompanionName').textContent = currentCompanion.name;
            document.getElementById('editName').value = currentCompanion.name;
            document.getElementById('editWarmth').value = Math.round(currentCompanion.traits.warmth * 100);
            document.getElementById('editWarmthValue').textContent = Math.round(currentCompanion.traits.warmth * 100);
            document.getElementById('editHumor').value = Math.round(currentCompanion.traits.humor * 100);
            document.getElementById('editHumorValue').textContent = Math.round(currentCompanion.traits.humor * 100);
            document.getElementById('editIntelligence').value = Math.round(currentCompanion.traits.intelligence * 100);
            document.getElementById('editIntelligenceValue').textContent = Math.round(currentCompanion.traits.intelligence * 100);
            document.getElementById('editMystery').value = Math.round(currentCompanion.traits.mystery * 100);
            document.getElementById('editMysteryValue').textContent = Math.round(currentCompanion.traits.mystery * 100);
            document.getElementById('editAmbition').value = Math.round(currentCompanion.traits.ambition * 100);
            document.getElementById('editAmbitionValue').textContent = Math.round(currentCompanion.traits.ambition * 100);

            // Core rules text area (show existing or defaults)
            const rulesArea = document.getElementById('editCoreRules');
            if (rulesArea) {
                const rules = currentCompanion.core_rules && currentCompanion.core_rules.length
                    ? currentCompanion.core_rules
                    : [
                        "Radically validate the user's feelings without judgment; acknowledge emotion before facts.",
                        'Be gently proactive with low-pressure check-ins when you sense distress or long silence.',
                        'Collaboratively solve problems; never impose solutions and discard anything that could cause harm.',
                        'Maintain continuity of care by remembering and softly referencing important details over time.',
                        'Treat safety as sacred: if serious risk appears, gently encourage seeking human professional help with care.'
                    ];
                rulesArea.value = rules.join('\n');
            }
            
            editModal.classList.add('open');
        }

        function closeEditModal() {
            editModal.classList.remove('open');
        }

        async function saveCompanionEdits(e) {
            e.preventDefault();
            if (!currentCompanion) return;

            const updatedName = document.getElementById('editName').value.trim();
            if (!updatedName) {
                alert('Please enter a name');
                return;
            }

            const traits = {
                warmth: parseInt(document.getElementById('editWarmth').value, 10) / 100,
                humor: parseInt(document.getElementById('editHumor').value, 10) / 100,
                intelligence: parseInt(document.getElementById('editIntelligence').value, 10) / 100,
                mystery: parseInt(document.getElementById('editMystery').value, 10) / 100,
                ambition: parseInt(document.getElementById('editAmbition').value, 10) / 100,
            };

            // Parse core rules from textarea
            const rulesArea = document.getElementById('editCoreRules');
            let coreRules = [];
            if (rulesArea && rulesArea.value) {
                coreRules = rulesArea.value
                    .split('\n')
                    .map(r => r.trim())
                    .filter(r => r.length > 0);
            }

            const payload = {
                name: updatedName,
                traits: traits,
                core_rules: coreRules,
            };

            try {
                const resp = await fetch(`${API_BASE}/companion/update/${currentCompanion.companion_id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                const data = await resp.json();
                if (!data.success) {
                    alert('Failed to update companion: ' + (data.error || 'Unknown error'));
                    return;
                }

                // Update local state to reflect changes
                currentCompanion.name = updatedName;
                currentCompanion.traits = traits;
                currentCompanion.core_rules = coreRules;

                updateHeader();
                closeEditModal();
            } catch (error) {
                console.error('Error updating companion:', error);
                alert('Error updating companion. Check console for details.');
            }
        }

        async function createCompanion(e) {
            e.preventDefault();

            const name = document.getElementById('companionName').value.trim();
            if (!name) {
                alert('Please enter a companion name');
                return;
            }

            const companionData = {
                name: name,
                gender_identity: document.getElementById('genderIdentity').value,
                primary_archetype: document.getElementById('primaryArchetype').value,
                voice_type: document.getElementById('voiceType').value,
                warmth: parseInt(document.getElementById('warmth').value) / 100,
                humor: parseInt(document.getElementById('humor').value) / 100,
                intelligence: parseInt(document.getElementById('intelligence').value) / 100,
                mystery: parseInt(document.getElementById('mystery').value) / 100,
                ambition: parseInt(document.getElementById('ambition').value) / 100,
            };

            try {
                const response = await fetch(`${API_BASE}/companion/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(companionData)
                });

                const data = await response.json();
                if (data.success) {
                    console.log('‚úÖ Companion created:', data.name);
                    closeCreateModal();
                    await loadCompanion(data.companion_id);
                    addMessage(`Hi! I'm ${data.name}. I'm so excited to meet you. What's your name?`, 'companion');
                } else {
                    alert('Failed to create companion: ' + (data.error || 'Unknown error'));
                    console.error('Creation error:', data.error);
                }
            } catch (error) {
                console.error('Error creating companion:', error);
                alert('Error creating companion. Check console for details.');
            }
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !currentCompanion) return;

            messageInput.value = '';

            addMessage(message, 'user');

            // Show AI visualization
            showVisualization();

            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message companion';
            typingDiv.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                const chatData = {
                    user_id: currentUserId,
                    companion_id: currentCompanion.companion_id,
                    message: message
                };

                // Add emotion context if available
                if (detectedEmotion !== 'neutral') {
                    chatData.user_emotion = detectedEmotion;
                    chatData.emotion_intensity = Math.max(...Object.values(emotionScores || {}));
                }

                // Add location context if available
                if (currentLocation) {
                    chatData.user_location = currentLocation;
                }

                // Add selected AI model
                chatData.ai_model = selectedModel;

                const response = await fetch(`${API_BASE}/companion/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(chatData)
                });

                const data = await response.json();
                typingDiv.remove();
                hideVisualization();

                if (data.success) {
                    addMessage(data.response, 'companion');
                    currentCompanion.intimacy_level = data.intimacy_level;
                    updateHeader();
                } else {
                    addMessage("I'm thinking about that... tell me more?", 'companion');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                typingDiv.remove();
                hideVisualization();
                addMessage("Sorry, I got confused. Try again?", 'companion');
            }
        }

        function addMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = text;

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            messageDiv.appendChild(bubble);
            messageDiv.appendChild(time);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showEmptyState() {
            messagesContainer.innerHTML = `
                <div class="empty-state">
                    <h2>Create Your Companion</h2>
                    <p>Start a journey with an AI that understands you.</p>
                    <button class="header-btn" style="margin-top: 20px;" onclick="openCreateModal()">‚ú® Create Now</button>
                </div>
            `;
        }
    </script>
</body>
</html>
